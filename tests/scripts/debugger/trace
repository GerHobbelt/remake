# -*-Perl-*-
# $Id: trace,v 1.3 2004/07/18 22:38:08 rockyb Exp $
$description = "The following checks tracing.\n";

$details = "We test line tracing, showing a target stack, line numbers\n"
         . "when we have multiple commands in a target\n";

# TEST #1
# -------

open(MAKEFILE,"> $makefile");

# The Contents of the MAKEFILE ...

print MAKEFILE <<\EOF;
# Test #1 simple tracing
all: foo

foo:
	@echo FOO here
EOF
# END of Contents of MAKEFILE

close(MAKEFILE);

&run_make_with_options($makefile,"--trace --basename-filenames",
                       &get_logfile);

# Create the answer to what should be produced by this Makefile

$answer = "work/debugger/trace.mk:4 foo
work/debugger/trace.mk:5 foo
	echo FOO here
FOO here
";

# COMPARE RESULTS

&compare_output($answer,&get_logfile(1));

# TEST #2 Test #2 tracing with multiple commands and show call stack
# dump
# -------

open(MAKEFILE,"> $makefile");

# The Contents of the MAKEFILE ...

print MAKEFILE <<\EOF;
# Test #2 tracing with multiple commands and show call stack dump
all: foo
foo:
	@echo hi > /dev/null
	@exit 5
EOF
# END of Contents of MAKEFILE

close(MAKEFILE);

# We used option --trace in test 1, use short option name -x this time.
&run_make_with_options($makefile, "-E -x -i --basename-filenames",
		       &get_logfile);

# Create the answer to what should be produced by this Makefile

$answer = "work/debugger/trace.mk:3 foo
work/debugger/trace.mk:4 foo
	echo hi > /dev/null
work/debugger/trace.mk:5 foo
	exit 5
work/debugger/trace.mk:5: [foo] Error 5 (ignored)

#0  foo at work/debugger/trace.mk:5
#1  all at work/debugger/trace.mk:2
";

# COMPARE RESULTS

&compare_output($answer,&get_logfile(1));

# TEST #3 Test #3 "tracing" vs "silent"
# dump
# -------

open(MAKEFILE,"> $makefile");

# The Contents of the MAKEFILE ...

print MAKEFILE <<\EOF;
# Test #3 "tracing" versus "silent"
.SILENT: foo

all: foo

foo:
	if [ -n FOO ] ; \
	then echo "test okay"; fi
EOF
# END of Contents of MAKEFILE

close(MAKEFILE);

# We used option --trace in test 1, use short option name -x this time.
&run_make_with_options($makefile, "-E -x -i --basename-filenames",
		       &get_logfile);

# Create the answer to what should be produced by this Makefile

$answer = "work/debugger/trace.mk:6 foo
work/debugger/trace.mk:7 foo
	if [ -n FOO ] ; \\
then echo \"test okay\"; fi
test okay
";

# COMPARE RESULTS

&compare_output($answer,&get_logfile(1));
